name: Auto Update Key Every 12 Hours

on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:

jobs:
  update-key:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read previous key
        id: oldkey
        run: |
          if [ -f key.txt ]; then
            OLD_KEY=$(cat key.txt)
            echo "OLD_KEY=$OLD_KEY" >> $GITHUB_ENV
          else
            echo "OLD_KEY=None" >> $GITHUB_ENV
          fi

      - name: Generate new random key
        id: gen
        run: |
          NEW_KEY=$(openssl rand -base64 24 | tr -dc 'A-Za-z0-9' | head -c 32)
          echo "$NEW_KEY" > key.txt
          echo "NEW_KEY=$NEW_KEY" >> $GITHUB_ENV

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add key.txt
          if git diff --staged --quiet; then
            exit 0
          else
            git commit -m "ðŸ”‘ Auto-update key - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push
          fi

      - name: Send embed to Discord
        if: env.NEW_KEY != ''
        run: |
          WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK }}"
          if [ -z "$WEBHOOK_URL" ]; then
            exit 0
          fi
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          OLD="${{ env.OLD_KEY }}"
          NEW="${{ env.NEW_KEY }}"
          JSON_PAYLOAD=$(jq -n \
            --arg title "ðŸ”‘ Key Updated" \
            --arg old "$OLD" \
            --arg new "$NEW" \
            --arg time "$CURRENT_TIME" \
            '{
              "embeds": [{
                "title": $title,
                "color": 16711680,
                "fields": [
                  { "name": "Old Key", "value": ("```" + $old + "```"), "inline": false },
                  { "name": "New Key", "value": ("```" + $new + "```"), "inline": false }
                ],
                "footer": { "text": ("Updated at " + $time) }
              }]
            }')
          curl -X POST -H "Content-Type: application/json" -d "$JSON_PAYLOAD" "$WEBHOOK_URL"
